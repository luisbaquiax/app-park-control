
<div class="recover-password-container">
  
  <div class="floating-icons">
    <div class="icon"><mat-icon>local_shipping</mat-icon></div>
    <div class="icon"><mat-icon>local_parking</mat-icon></div>
    <div class="icon"><mat-icon>directions_car</mat-icon></div>
    <div class="icon"><mat-icon>delivery_dining</mat-icon></div>
    <div class="icon"><mat-icon>garage</mat-icon></div>
    <div class="icon"><mat-icon>airport_shuttle</mat-icon></div>
    <div class="icon"><mat-icon>ev_station</mat-icon></div>
    <div class="icon"><mat-icon>navigation</mat-icon></div>
  </div>

  <mat-card class="recover-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>lock_reset</mat-icon>
        Recuperar Contraseña
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Paso 1: Solicitar recuperación -->
      <div *ngIf="currentStep === 1" class="step-container">
        <h3>Ingresa tu correo electrónico</h3>
        <p class="step-description">Te enviaremos un código de verificación</p>
        
        <form [formGroup]="emailForm" (ngSubmit)="requestRecovery()" class="recovery-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Correo electrónico</mat-label>
            <input matInput 
                   type="email" 
                   formControlName="correo"
                   placeholder="ejemplo@correo.com">
            <mat-icon matSuffix>email</mat-icon>
            <mat-error *ngIf="emailForm.get('correo')?.hasError('required')">
              El correo es requerido
            </mat-error>
            <mat-error *ngIf="emailForm.get('correo')?.hasError('email')">
              Ingresa un correo válido
            </mat-error>
          </mat-form-field>

          <button mat-raised-button 
                  color="primary" 
                  type="submit" 
                  [disabled]="emailForm.invalid || isLoading"
                  class="submit-button">
            <mat-icon *ngIf="!isLoading">send</mat-icon>
            <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
            {{ isLoading ? 'Enviando...' : 'Enviar Código' }}
          </button>
        </form>
      </div>

      <!-- Paso 2: Verificar código -->
      <div *ngIf="currentStep === 2" class="step-container">
        <h3>Verificar Código</h3>
        <p class="step-description">Ingresa el código que enviamos a {{ userEmail }}</p>
        
        <form [formGroup]="verificationForm" (ngSubmit)="verificaCodigoDeSeguridad()" class="recovery-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Código de verificación</mat-label>
            <input matInput 
                   type="text" 
                   formControlName="codigoVerificacion"
                   placeholder="123456"
                   maxlength="6">
            <mat-icon matSuffix>verified_user</mat-icon>
            <mat-error *ngIf="verificationForm.get('codigoVerificacion')?.hasError('required')">
              El código es requerido
            </mat-error>
            <mat-error *ngIf="verificationForm.get('codigoVerificacion')?.hasError('pattern')">
              El código debe tener 6 dígitos
            </mat-error>
          </mat-form-field>

          <div class="button-group">
            <button mat-button 
                    type="button" 
                    (click)="goBack()"
                    [disabled]="isLoading">
              <mat-icon>arrow_back</mat-icon>
              Atrás
            </button>
            
            <button mat-raised-button 
                    color="primary" 
                    type="submit" 
                    [disabled]="verificationForm.invalid || isLoading">
              <mat-icon *ngIf="!isLoading">check</mat-icon>
              <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
              {{ isLoading ? 'Verificando...' : 'Verificar' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Paso 3: Nueva contraseña -->
      <div *ngIf="currentStep === 3" class="step-container">
        <h3>Nueva Contraseña</h3>
        <p class="step-description">Hola {{ userName }}, establece tu nueva contraseña</p>
        
        <form [formGroup]="passwordForm" (ngSubmit)="resetPassword()" class="recovery-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nueva contraseña</mat-label>
            <input matInput 
                   [type]="hidePassword ? 'password' : 'text'" 
                   formControlName="nuevaContrasenia"
                   placeholder="Mínimo 8 caracteres">
            <button mat-icon-button 
                    matSuffix 
                    type="button"
                    (click)="hidePassword = !hidePassword">
              <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-error *ngIf="passwordForm.get('nuevaContrasenia')?.hasError('required')">
              La contraseña es requerida
            </mat-error>
            <mat-error *ngIf="passwordForm.get('nuevaContrasenia')?.hasError('minlength')">
              La contraseña debe tener al menos 8 caracteres
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirmar contraseña</mat-label>
            <input matInput 
                   [type]="hideConfirmPassword ? 'password' : 'text'" 
                   formControlName="confirmarContrasenia"
                   placeholder="Repite la contraseña">
            <button mat-icon-button 
                    matSuffix 
                    type="button"
                    (click)="hideConfirmPassword = !hideConfirmPassword">
              <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-error *ngIf="passwordForm.get('confirmarContrasenia')?.hasError('required')">
              Debes confirmar la contraseña
            </mat-error>
            <mat-error *ngIf="passwordForm.hasError('passwordMismatch')">
              Las contraseñas no coinciden
            </mat-error>
          </mat-form-field>

          <div class="button-group">
            <button mat-button 
                    type="button" 
                    (click)="goBack()"
                    [disabled]="isLoading">
              <mat-icon>arrow_back</mat-icon>
              Atrás
            </button>
            
            <button mat-raised-button 
                    color="primary" 
                    type="submit" 
                    [disabled]="passwordForm.invalid || isLoading">
              <mat-icon *ngIf="!isLoading">save</mat-icon>
              <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
              {{ isLoading ? 'Guardando...' : 'Cambiar Contraseña' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Paso 4: Confirmación -->
      <div *ngIf="currentStep === 4" class="step-container success-container">
        <div class="success-icon">
          <mat-icon color="primary">check_circle</mat-icon>
        </div>
        <h3>¡Contraseña actualizada!</h3>
        <p class="step-description">Tu contraseña se ha cambiado exitosamente</p>
        
        <button mat-raised-button 
                color="primary" 
                (click)="goToLogin()"
                class="submit-button">
          <mat-icon>login</mat-icon>
          Ir al Login
        </button>
      </div>
    </mat-card-content>

    <!-- Stepper indicator -->
    <mat-card-actions class="stepper-indicator">
      <div class="step-indicator">
        <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">1</div>
        <div class="connector" [class.completed]="currentStep > 1"></div>
        <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">2</div>
        <div class="connector" [class.completed]="currentStep > 2"></div>
        <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">3</div>
        <div class="connector" [class.completed]="currentStep > 3"></div>
        <div class="step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">4</div>
      </div>
    </mat-card-actions>
  </mat-card>
  
</div>