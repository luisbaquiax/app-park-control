<div class="subscription-management-container">
  <!-- Iconos flotantes de fondo -->
  <div class="floating-icons">
    <div class="icon"><mat-icon>card_membership</mat-icon></div>
    <div class="icon"><mat-icon>local_offer</mat-icon></div>
    <div class="icon"><mat-icon>shopping_cart</mat-icon></div>
    <div class="icon"><mat-icon>autorenew</mat-icon></div>
    <div class="icon"><mat-icon>directions_car</mat-icon></div>
    <div class="icon"><mat-icon>payment</mat-icon></div>
    <div class="icon"><mat-icon>star</mat-icon></div>
    <div class="icon"><mat-icon>verified</mat-icon></div>
  </div>

  <!-- Card Principal -->
  <mat-card class="usuario-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="header-icon">subscriptions</mat-icon>
        Gestión de Suscripciones
      </mat-card-title>
      <mat-card-subtitle>Administre sus planes y suscripciones activas</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group animationDuration="300ms" class="sucursales-tabs">
        
        <!-- TAB 1: PLANES DISPONIBLES -->
        <mat-tab label="Planes Disponibles">
          <div class="tab-content">
            
            <!-- Loading -->
            <div class="no-results" *ngIf="isLoadingSuscripciones">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Cargando planes disponibles...</p>
            </div>

            <!-- Empresas y sus suscripciones -->
            <div *ngIf="!isLoadingSuscripciones && empresasSuscripciones.length > 0">
              <div *ngFor="let empresa of empresasSuscripciones" class="empresa-section">
                
                <!-- Info de la Empresa -->
                <div class="empresa-header">
                  <div class="empresa-info">
                    <h2 class="empresa-nombre">
                      <mat-icon>business</mat-icon>
                      {{empresa.nombreComercial}}
                    </h2>
                    <p class="empresa-detalles">
                      <span><mat-icon>assignment</mat-icon> NIT: {{empresa.nit}}</span>
                      <span><mat-icon>phone</mat-icon> {{empresa.telefonoContacto}}</span>
                    </p>
                  </div>
                </div>

                <!-- Planes de la Empresa -->
                <div class="planes-grid">
                  <mat-card *ngFor="let plan of empresa.suscripciones" class="plan-card">
                    <div class="plan-badge">{{plan.nombrePlan}}</div>
                    
                    <mat-card-header>
                      <mat-card-title>{{plan.codigoPlan}}</mat-card-title>
                      <mat-card-subtitle>{{plan.descripcion}}</mat-card-subtitle>
                    </mat-card-header>

                    <mat-card-content>
                      <div class="plan-precio">
                        {{formatearPrecio(plan.precioPlan)}}
                        <span class="precio-periodo">/mes</span>
                      </div>

                      <div class="plan-features">
                        <div class="feature">
                          <mat-icon>schedule</mat-icon>
                          <span><strong>{{plan.horasMensuales}} horas/mes</strong> ({{plan.horasDia}} hrs/día)</span>
                        </div>
                        <div class="feature">
                          <mat-icon>event</mat-icon>
                          <span>{{plan.diasAplicables}}</span>
                        </div>
                        <div class="feature">
                          <mat-icon>access_time</mat-icon>
                          <span>{{plan.coberturaHoraria}}</span>
                        </div>
                        <div class="feature" *ngIf="plan.configuracionDescuento.descuentoMensual > 0">
                          <mat-icon>local_offer</mat-icon>
                          <span>{{plan.configuracionDescuento.descuentoMensual}}% descuento mensual</span>
                        </div>
                        <div class="feature" *ngIf="plan.configuracionDescuento.descuentoAnualAdicional > 0">
                          <mat-icon>card_giftcard</mat-icon>
                          <span>{{plan.configuracionDescuento.descuentoAnualAdicional}}% adicional anual</span>
                        </div>
                      </div>

                      <div class="plan-estado">
                        <mat-chip [class]="getEstadoColor(plan.activo)">
                          {{plan.activo}}
                        </mat-chip>
                      </div>
                    </mat-card-content>

                    <mat-card-actions>
                      <button mat-raised-button 
                              color="primary" 
                              (click)="abrirModalCompra(plan, empresa)"
                              class="buy-button">
                        <mat-icon>shopping_cart</mat-icon>
                        Comprar Plan
                      </button>
                    </mat-card-actions>
                  </mat-card>
                </div>

                <!-- Sucursales de la Empresa -->
                <div class="sucursales-info" *ngIf="empresa.sucursales.length > 0">
                  <h3 class="section-title">
                    <mat-icon>store</mat-icon>
                    Sucursales Disponibles ({{empresa.sucursales.length}})
                  </h3>
                  <div class="sucursales-grid">
                    <mat-card *ngFor="let sucursal of empresa.sucursales" class="sucursal-mini-card">
                      <div class="sucursal-content">
                        <h4><mat-icon>place</mat-icon> {{sucursal.nombre}}</h4>
                        <p>{{sucursal.direccionCompleta}}</p>
                        <p class="sucursal-ciudad">{{sucursal.ciudad}}, {{sucursal.departamento}}</p>
                        <p class="sucursal-horario">
                          <mat-icon>schedule</mat-icon>
                          {{sucursal.horaApertura}} - {{sucursal.horaCierre}}
                        </p>
                      </div>
                    </mat-card>
                  </div>
                </div>

              </div>
            </div>

            <!-- Mensaje cuando no hay planes -->
            <div class="no-results" *ngIf="!isLoadingSuscripciones && empresasSuscripciones.length === 0">
              <mat-icon>inbox</mat-icon>
              <p>No hay planes disponibles en este momento</p>
            </div>

          </div>
        </mat-tab>

        <!-- TAB 2: MIS SUSCRIPCIONES ACTIVAS -->
        <mat-tab label="Mis Suscripciones">
          <div class="tab-content">
            
            <!-- Loading -->
            <div class="no-results" *ngIf="isLoadingActivas">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Cargando suscripciones activas...</p>
            </div>

            <!-- Suscripciones Activas -->
            <div *ngIf="!isLoadingActivas && suscripcionesActivas.length > 0">
              <h3 class="section-title">
                <mat-icon>card_membership</mat-icon>
                Mis Suscripciones Activas ({{suscripcionesActivas.length}})
              </h3>

              <div class="suscripciones-grid">
                <mat-card *ngFor="let suscripcion of suscripcionesActivas" class="suscripcion-card">
                  
                  <!-- Badge del Plan -->
                  <div class="plan-badge-top">{{suscripcion.tipoPlanSuscripcionDTO.nombrePlan}}</div>
                  
                  <!-- Alerta de Renovación -->
                  <div class="alerta-renovacion-mini" *ngIf="estaProximoAVencer(suscripcion.fechaFin)">
                    <mat-icon>warning</mat-icon>
                    <span>¡Vence en {{diasRestantes(suscripcion.fechaFin)}} días!</span>
                  </div>

                  <mat-card-header>
                    <div class="suscripcion-header-info">
                      <mat-card-title>
                        <mat-icon>{{getIconoVehiculo(suscripcion.vehiculoClienteDTO.tipoVehiculo)}}</mat-icon>
                        {{suscripcion.vehiculoClienteDTO.placa}}
                      </mat-card-title>
                      <mat-card-subtitle>
                        {{suscripcion.vehiculoClienteDTO.marca}} {{suscripcion.vehiculoClienteDTO.modelo}} - {{suscripcion.vehiculoClienteDTO.color}}
                      </mat-card-subtitle>
                    </div>
                    <mat-chip [class]="getEstadoColor(suscripcion.estadoSuscripcion)">
                      {{suscripcion.estadoSuscripcion}}
                    </mat-chip>
                  </mat-card-header>

                  <mat-card-content>
                    
                    <!-- Información Principal -->
                    <div class="info-block">
                      <h4><mat-icon>info</mat-icon> Plan Contratado</h4>
                      <div class="info-grid-mini">
                        <div class="info-item-mini">
                          <span class="label">Código:</span>
                          <span class="value">{{suscripcion.tipoPlanSuscripcionDTO.codigoPlan}}</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Período:</span>
                          <span class="value">{{suscripcion.periodoContratado}}</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Precio:</span>
                          <span class="value price">{{formatearPrecio(suscripcion.precioPlan)}}</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Descuento:</span>
                          <span class="value">{{suscripcion.descuentoAplicado}}%</span>
                        </div>
                      </div>
                      <p class="descripcion">{{suscripcion.tipoPlanSuscripcionDTO.descripcion}}</p>
                    </div>

                    <!-- Horas y Cobertura -->
                    <div class="info-block">
                      <h4><mat-icon>schedule</mat-icon> Horas y Cobertura</h4>
                      <div class="info-grid-mini">
                        <div class="info-item-mini">
                          <span class="label">Horas Incluidas:</span>
                          <span class="value">{{suscripcion.horasMensualesIncluidas}} hrs/mes</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Horas por Día:</span>
                          <span class="value">{{suscripcion.tipoPlanSuscripcionDTO.horasDia}} hrs/día</span>
                        </div>
                        <div class="info-item-mini full-width">
                          <span class="label">Horas Consumidas:</span>
                          <span class="value highlight">{{suscripcion.horasConsumidas}} hrs</span>
                        </div>
                        <div class="info-item-mini full-width">
                          <span class="label">Horas Restantes:</span>
                          <span class="value highlight">{{suscripcion.horasMensualesIncluidas - suscripcion.horasConsumidas}} hrs</span>
                        </div>
                      </div>
                      
                      <!-- Barra de progreso de horas -->
                      <div class="progress-bar-container">
                        <div class="progress-bar" 
                             [style.width.%]="(suscripcion.horasConsumidas / suscripcion.horasMensualesIncluidas) * 100">
                        </div>
                      </div>
                      <p class="progress-text">
                        {{((suscripcion.horasConsumidas / suscripcion.horasMensualesIncluidas) * 100).toFixed(1)}}% consumido
                      </p>
                    </div>

                    <!-- Cobertura del Plan -->
                    <div class="info-block">
                      <h4><mat-icon>event</mat-icon> Detalles de Cobertura</h4>
                      <div class="info-grid-mini">
                        <div class="info-item-mini full-width">
                          <span class="label">Días Aplicables:</span>
                          <span class="value">{{suscripcion.tipoPlanSuscripcionDTO.diasAplicables}}</span>
                        </div>
                        <div class="info-item-mini full-width">
                          <span class="label">Horario:</span>
                          <span class="value">{{suscripcion.tipoPlanSuscripcionDTO.coberturaHoraria}}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Fechas -->
                    <div class="info-block">
                      <h4><mat-icon>date_range</mat-icon> Vigencia</h4>
                      <div class="info-grid-mini">
                        <div class="info-item-mini">
                          <span class="label">Fecha Compra:</span>
                          <span class="value">{{formatearFecha(suscripcion.fechaCompra)}}</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Fecha Inicio:</span>
                          <span class="value">{{formatearFecha(suscripcion.fechaInicio)}}</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Fecha Fin:</span>
                          <span class="value highlight">{{formatearFecha(suscripcion.fechaFin)}}</span>
                        </div>
                        <div class="info-item-mini">
                          <span class="label">Días Restantes:</span>
                          <span class="value" [class.warning]="diasRestantes(suscripcion.fechaFin) <= 7">
                            <mat-icon>schedule</mat-icon> {{diasRestantes(suscripcion.fechaFin)}} días
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Sucursales Disponibles -->
                    <div class="info-block" *ngIf="suscripcion.sucursalesDisponibles.length > 0">
                      <h4>
                        <mat-icon>store</mat-icon> 
                        Sucursales Disponibles ({{suscripcion.sucursalesDisponibles.length}})
                      </h4>
                      <div class="sucursales-mini-grid">
                        <div *ngFor="let sucursal of suscripcion.sucursalesDisponibles" class="sucursal-mini">
                          <mat-icon>place</mat-icon>
                          <div>
                            <strong>{{sucursal.nombre}}</strong>
                            <p>{{sucursal.ciudad}}, {{sucursal.departamento}}</p>
                            <p class="horario">{{sucursal.horaApertura}} - {{sucursal.horaCierre}}</p>
                          </div>
                        </div>
                      </div>
                    </div>

                  </mat-card-content>

                  <mat-card-actions>
                    <!-- Botón de Renovación -->
                    <button mat-raised-button 
                            color="primary" 
                            (click)="abrirModalRenovacion(suscripcion)"
                            *ngIf="estaProximoAVencer(suscripcion.fechaFin)"
                            class="renovar-button urgente">
                      <mat-icon>autorenew</mat-icon>
                      ¡Renovar Ahora! (Vence en {{diasRestantes(suscripcion.fechaFin)}} días)
                    </button>
                    
                    <!-- Botón de Permiso Temporal -->
                    <button mat-raised-button 
                            color="accent" 
                            (click)="abrirModalPermisoTemporal(suscripcion)"
                            *ngIf="suscripcion.estadoSuscripcion === 'ACTIVA'"
                            class="permiso-button">
                      <mat-icon>car_rental</mat-icon>
                      Solicitar Permiso Temporal
                    </button>

                    <!-- Mensaje informativo si faltan más de 7 días -->
                    <div class="renovacion-info" *ngIf="!estaProximoAVencer(suscripcion.fechaFin)">
                      <mat-icon>info</mat-icon>
                      <span>Podrás renovar cuando falten 7 días o menos para el vencimiento</span>
                    </div>
                  </mat-card-actions>

                </mat-card>
              </div>
            </div>

            <!-- Mensaje cuando no hay suscripciones -->
            <div class="no-results" *ngIf="!isLoadingActivas && suscripcionesActivas.length === 0">
              <mat-icon>inbox</mat-icon>
              <p>No tienes suscripciones activas</p>
              <p class="subtitle">Explora nuestros planes disponibles en la pestaña anterior</p>
            </div>

          </div>
        </mat-tab>

        <!-- TAB 3: MIS VEHÍCULOS -->
        <mat-tab label="Mis Vehículos">
          <div class="tab-content">
            
            <!-- Loading -->
            <div class="no-results" *ngIf="isLoadingVehiculos">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Cargando vehículos...</p>
            </div>

            <!-- Lista de Vehículos -->
            <div *ngIf="!isLoadingVehiculos && vehiculos.length > 0">
              <h3 class="section-title">
                <mat-icon>directions_car</mat-icon>
                Mis Vehículos Registrados ({{vehiculos.length}})
              </h3>

              <div class="vehiculos-grid">
                <mat-card *ngFor="let vehiculo of vehiculos" class="vehiculo-card">
                  <div class="vehiculo-icon">
                    <mat-icon [class]="vehiculo.tipoVehiculo === 'DOS_RUEDAS' ? 'moto-icon' : 'car-icon'">
                      {{getIconoVehiculo(vehiculo.tipoVehiculo)}}
                    </mat-icon>
                  </div>
                  
                  <mat-card-content>
                    <div class="vehiculo-placa">{{vehiculo.placa}}</div>
                    <div class="vehiculo-info">
                      <p><strong>Marca:</strong> {{vehiculo.marca}}</p>
                      <p><strong>Modelo:</strong> {{vehiculo.modelo}}</p>
                      <p><strong>Color:</strong> {{vehiculo.color}}</p>
                      <p><strong>Tipo:</strong> 
                        {{vehiculo.tipoVehiculo === 'DOS_RUEDAS' ? '2 Ruedas' : '4 Ruedas'}}
                      </p>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>

            <!-- Mensaje cuando no hay vehículos -->
            <div class="no-results" *ngIf="!isLoadingVehiculos && vehiculos.length === 0">
              <mat-icon>directions_car_filled</mat-icon>
              <p>No tienes vehículos registrados</p>
              <p class="subtitle">Registra un vehículo para poder adquirir suscripciones</p>
            </div>

          </div>
        </mat-tab>

      </mat-tab-group>
    </mat-card-content>
  </mat-card>

  <!-- MODAL DE COMPRA DE SUSCRIPCIÓN -->
  <div class="modal-overlay" *ngIf="mostrarModalCompra">
    <div class="encargado-modal" (click)="$event.stopPropagation()">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <button mat-icon-button class="close-icon-button" (click)="cerrarModalCompra()">
          <mat-icon>close</mat-icon>
        </button>
        <div class="modal-icon">
          <mat-icon>shopping_cart</mat-icon>
        </div>
        <h2>Comprar Suscripción</h2>
        <p class="modal-subtitle" *ngIf="suscripcionSeleccionada">
          {{suscripcionSeleccionada.nombrePlan}} - {{suscripcionSeleccionada.codigoPlan}}
        </p>
      </div>

      <!-- Contenido del Modal -->
      <div class="modal-content" *ngIf="suscripcionSeleccionada && empresaSeleccionada">
        
        <!-- Información del Plan -->
        <div class="info-section">
          <h3 class="info-section-title">
            <mat-icon>info</mat-icon>
            Resumen del Plan
          </h3>
          <div class="plan-resumen">
            <p><strong>Empresa:</strong> {{empresaSeleccionada.nombreComercial}}</p>
            <p><strong>Plan:</strong> {{suscripcionSeleccionada.nombrePlan}}</p>
            <p><strong>Descripción:</strong> {{suscripcionSeleccionada.descripcion}}</p>
            <p><strong>Precio Base:</strong> {{formatearPrecio(suscripcionSeleccionada.precioPlan)}}/mes</p>
            <p><strong>Horas Mensuales:</strong> {{suscripcionSeleccionada.horasMensuales}} hrs</p>
          </div>
        </div>

        <!-- Formulario -->
        <form [formGroup]="compraForm" class="usuario-form">
          
          <div class="info-section">
            <h3 class="info-section-title">
              <mat-icon>settings</mat-icon>
              Configuración de Compra
            </h3>
            
            <!-- Select de Vehículo -->
            <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
              <mat-label>Seleccione su Vehículo</mat-label>
              <mat-select formControlName="idVehiculo" name="vehiculo">
                <mat-option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.idVehiculo">
                  {{vehiculo.placa}} - {{vehiculo.marca}} {{vehiculo.modelo}}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="vehiculos.length === 0">No hay vehículos disponibles</mat-hint>
              <mat-error *ngIf="compraForm.get('idVehiculo')?.hasError('required')">
                Debe seleccionar un vehículo
              </mat-error>
            </mat-form-field>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <!-- Select de Período -->
              <mat-form-field appearance="outline" style="flex: 1; min-width: 200px;">
                <mat-label>Período de Contratación</mat-label>
                <mat-select formControlName="periodoContratado" name="periodo">
                  <mat-option value="MENSUAL">Mensual</mat-option>
                  <mat-option value="ANUAL">Anual</mat-option>
                </mat-select>
                <mat-error *ngIf="compraForm.get('periodoContratado')?.hasError('required')">
                  Debe seleccionar un período
                </mat-error>
              </mat-form-field>

              <!-- Select de Método de Pago -->
              <mat-form-field appearance="outline" style="flex: 1; min-width: 200px;">
                <mat-label>Método de Pago</mat-label>
                <mat-select formControlName="metodoPago" name="metodoPago">
                  <mat-option value="TARJETA_CREDITO">Tarjeta de Crédito</mat-option>
                  <mat-option value="TARJETA_DEBITO">Tarjeta de Débito</mat-option>
                  <mat-option value="TRANSFERENCIA_BANCARIA">Transferencia Bancaria</mat-option>
                  <mat-option value="PAYPAL">PayPal</mat-option>
                  <mat-option value="OTRO">Otro</mat-option>
                </mat-select>
                <mat-error *ngIf="compraForm.get('metodoPago')?.hasError('required')">
                  Debe seleccionar un método de pago
                </mat-error>
              </mat-form-field>
            </div>

          </div>

        </form>
      </div>

      <!-- Botones del Modal -->
      <div class="modal-actions">
        <button mat-stroked-button 
                class="cancel-button"
                (click)="cerrarModalCompra()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        
        <button mat-raised-button 
                color="primary" 
                (click)="comprarSuscripcion()"
                [disabled]="compraForm.invalid || isLoading"
                class="submit-button">
          <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
          <mat-icon *ngIf="!isLoading">shopping_cart</mat-icon>
          <span *ngIf="!isLoading">Confirmar Compra</span>
          <span *ngIf="isLoading">Procesando...</span>
        </button>
      </div>
      
    </div>
  </div>

  <!-- MODAL DE RENOVACIÓN DE SUSCRIPCIÓN -->
  <div class="modal-overlay" *ngIf="mostrarModalRenovacion" (click)="cerrarModalRenovacion($event)">
    <div class="encargado-modal" (click)="$event.stopPropagation()">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <div class="modal-icon">
          <mat-icon>autorenew</mat-icon>
        </div>
        <h2>Renovar Suscripción</h2>
        <p class="modal-subtitle" *ngIf="suscripcionActivaSeleccionada">
          {{suscripcionActivaSeleccionada.tipoPlanSuscripcionDTO.nombrePlan}}
        </p>
      </div>

      <!-- Contenido del Modal -->
      <div class="modal-content" *ngIf="suscripcionActivaSeleccionada">
        
        <!-- Información Actual -->
        <div class="info-section">
          <h3 class="info-section-title">
            <mat-icon>info</mat-icon>
            Suscripción Actual
          </h3>
          <div class="plan-resumen">
            <p><strong>Plan:</strong> {{suscripcionActivaSeleccionada.tipoPlanSuscripcionDTO.nombrePlan}}</p>
            <p><strong>Vehículo:</strong> {{suscripcionActivaSeleccionada.vehiculoClienteDTO.placa}}</p>
            <p><strong>Vence:</strong> {{formatearFechaLegible(suscripcionActivaSeleccionada.fechaFin)}}</p>
            <p><strong>Días Restantes:</strong> {{diasRestantes(suscripcionActivaSeleccionada.fechaFin)}} días</p>
          </div>
        </div>

        <!-- Formulario -->
        <form [formGroup]="renovacionForm" class="usuario-form">
          
          <div class="info-section">
            <h3 class="info-section-title">
              <mat-icon>settings</mat-icon>
              Configuración de Renovación
            </h3>
            
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Nuevo Período</mat-label>
                <mat-select formControlName="nuevoPeriodoContratado">
                  <mat-option value="MENSUAL">Mensual</mat-option>
                  <mat-option value="ANUAL">Anual</mat-option>
                </mat-select>
                <mat-icon matPrefix>calendar_today</mat-icon>
                <mat-error *ngIf="renovacionForm.get('nuevoPeriodoContratado')?.hasError('required')">
                  Debe seleccionar un período
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Método de Pago</mat-label>
                <mat-select formControlName="metodoPago">
                  <mat-option value="TARJETA_CREDITO">Tarjeta de Crédito</mat-option>
                  <mat-option value="TARJETA_DEBITO">Tarjeta de Débito</mat-option>
                  <mat-option value="TRANSFERENCIA_BANCARIA">Transferencia Bancaria</mat-option>
                  <mat-option value="PAYPAL">PayPal</mat-option>
                  <mat-option value="OTRO">Otro</mat-option>
                </mat-select>
                <mat-icon matPrefix>payment</mat-icon>
                <mat-error *ngIf="renovacionForm.get('metodoPago')?.hasError('required')">
                  Debe seleccionar un método de pago
                </mat-error>
              </mat-form-field>
            </div>

          </div>

        </form>
      </div>

      <!-- Botones del Modal -->
      <div class="modal-actions">
        <button mat-stroked-button 
                class="cancel-button"
                (click)="cerrarModalRenovacion()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        
        <button mat-raised-button 
                color="primary" 
                (click)="renovarSuscripcion()"
                [disabled]="renovacionForm.invalid || isLoading"
                class="submit-button">
          <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
          <mat-icon *ngIf="!isLoading">autorenew</mat-icon>
          <span *ngIf="!isLoading">Confirmar Renovación</span>
          <span *ngIf="isLoading">Procesando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL DE PERMISO TEMPORAL -->
  <div class="modal-overlay" *ngIf="mostrarModalPermisoTemporal" (click)="cerrarModalPermisoTemporal($event)">
    <div class="encargado-modal" (click)="$event.stopPropagation()">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <button mat-icon-button class="close-icon-button" (click)="cerrarModalPermisoTemporal()">
          <mat-icon>close</mat-icon>
        </button>
        <div class="modal-icon">
          <mat-icon>car_rental</mat-icon>
        </div>
        <h2>Solicitar Permiso Temporal</h2>
        <p class="modal-subtitle" *ngIf="suscripcionActivaSeleccionada">
          {{suscripcionActivaSeleccionada.tipoPlanSuscripcionDTO.nombrePlan}}
        </p>
      </div>

      <!-- Contenido del Modal -->
      <div class="modal-content" *ngIf="suscripcionActivaSeleccionada">
        
        <!-- Información Actual -->
        <div class="info-section">
          <h3 class="info-section-title">
            <mat-icon>info</mat-icon>
            Información de la Suscripción
          </h3>
          <div class="plan-resumen">
            <p><strong>Plan:</strong> {{suscripcionActivaSeleccionada.tipoPlanSuscripcionDTO.nombrePlan}}</p>
            <p><strong>Vehículo Principal:</strong> {{suscripcionActivaSeleccionada.vehiculoClienteDTO.placa}}</p>
            <p><strong>Vigencia:</strong> {{formatearFechaLegible(suscripcionActivaSeleccionada.fechaFin)}}</p>
          </div>
          
          <div class="alerta-info">
            <mat-icon>info</mat-icon>
            <span>El permiso temporal permite utilizar otro vehículo temporalmente con esta suscripción</span>
          </div>
        </div>

        <!-- Formulario -->
        <form [formGroup]="permisoTemporalForm" class="usuario-form">
          
          <div class="info-section">
            <h3 class="info-section-title">
              <mat-icon>edit</mat-icon>
              Datos del Vehículo Temporal
            </h3>
            
            <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
              <mat-label>Vehículo Temporal</mat-label>
              <mat-select formControlName="placaTemporal">
                <mat-option *ngFor="let vehiculo of vehiculos" 
                            [value]="vehiculo.placa">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <mat-icon style="font-size: 18px; width: 18px; height: 18px;">
                      {{getIconoVehiculo(vehiculo.tipoVehiculo)}}
                    </mat-icon>
                    <span>{{vehiculo.placa}} - {{vehiculo.marca}} {{vehiculo.modelo}} ({{vehiculo.color}})</span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>directions_car</mat-icon>
              <mat-hint *ngIf="vehiculos.length === 0">No hay vehículos disponibles</mat-hint>
              <mat-hint *ngIf="vehiculos.length > 0">
                Seleccione un vehículo diferente al de la suscripción actual
              </mat-hint>
              <mat-error *ngIf="permisoTemporalForm.get('placaTemporal')?.hasError('required')">
                Debe seleccionar un vehículo
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
              <mat-label>Tipo de Vehículo</mat-label>
              <mat-select formControlName="tipoVehiculoPermitido">
                <mat-option *ngFor="let tipo of tiposVehiculoPermiso" [value]="tipo.value">
                  {{tipo.label}}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>directions_car</mat-icon>
              <mat-error *ngIf="permisoTemporalForm.get('tipoVehiculoPermitido')?.hasError('required')">
                Debe seleccionar el tipo de vehículo
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" style="width: 100%;">
              <mat-label>Motivo de la Solicitud</mat-label>
              <textarea matInput 
                        formControlName="motivo" 
                        rows="4"
                        placeholder="Explique brevemente el motivo por el cual necesita el permiso temporal..."
                        maxlength="500"></textarea>
              <mat-icon matPrefix>description</mat-icon>
              <mat-hint align="end">
                {{permisoTemporalForm.get('motivo')?.value?.length || 0}}/500 caracteres
              </mat-hint>
              <mat-error *ngIf="permisoTemporalForm.get('motivo')?.hasError('required')">
                El motivo es requerido
              </mat-error>
              <mat-error *ngIf="permisoTemporalForm.get('motivo')?.hasError('minlength')">
                El motivo debe tener al menos 10 caracteres
              </mat-error>
            </mat-form-field>

          </div>

        </form>
      </div>

      <!-- Botones del Modal -->
      <div class="modal-actions">
        <button mat-stroked-button 
                class="cancel-button"
                (click)="cerrarModalPermisoTemporal()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        
        <button mat-raised-button 
                color="accent" 
                (click)="solicitarPermisoTemporal()"
                [disabled]="permisoTemporalForm.invalid || isLoading"
                class="submit-button">
          <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
          <mat-icon *ngIf="!isLoading">send</mat-icon>
          <span *ngIf="!isLoading">Enviar Solicitud</span>
          <span *ngIf="isLoading">Procesando...</span>
        </button>
      </div>
    </div>
  </div>
</div>