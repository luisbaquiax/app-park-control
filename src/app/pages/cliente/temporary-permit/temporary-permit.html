<div class="crear-usuario-container">
  <div class="floating-icons">
    <div class="icon"><mat-icon>car_rental</mat-icon></div>
    <div class="icon"><mat-icon>access_time</mat-icon></div>
    <div class="icon"><mat-icon>verified_user</mat-icon></div>
    <div class="icon"><mat-icon>schedule</mat-icon></div>
    <div class="icon"><mat-icon>check_circle</mat-icon></div>
    <div class="icon"><mat-icon>local_parking</mat-icon></div>
    <div class="icon"><mat-icon>event_available</mat-icon></div>
    <div class="icon"><mat-icon>badge</mat-icon></div>
  </div>

  <mat-card class="usuario-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="header-icon">car_rental</mat-icon>
        Mis Permisos Temporales
      </mat-card-title>
      <mat-card-subtitle>Administre sus permisos de estacionamiento temporal</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="content-wrapper">
        
        <!-- Resumen de Estados -->
        <div class="stats-container">
          <div class="stat-card pendiente">
            <mat-icon>schedule</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{contarPermisosPorEstado('PENDIENTE')}}</span>
              <span class="stat-label">Pendientes</span>
            </div>
          </div>
          <div class="stat-card activo">
            <mat-icon>check_circle</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{contarPermisosPorEstado('ACTIVO')}}</span>
              <span class="stat-label">Activos</span>
            </div>
          </div>
          <div class="stat-card rechazado">
            <mat-icon>cancel</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{contarPermisosPorEstado('RECHAZADO')}}</span>
              <span class="stat-label">Rechazados</span>
            </div>
          </div>
          <div class="stat-card total">
            <mat-icon>assignment</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{permisos.length}}</span>
              <span class="stat-label">Total</span>
            </div>
          </div>
        </div>

        <!-- Lista de Permisos -->
        <div class="results-section" *ngIf="permisos.length > 0">
          <h3 class="section-title">
            <mat-icon>list</mat-icon>
            Mis Permisos Temporales ({{permisos.length}})
          </h3>

          <div class="permisos-grid">
            <div class="permiso-card" *ngFor="let permiso of permisos">
              
              <!-- Header de la tarjeta -->
              <div class="permiso-header">
                <div class="permiso-placa">
                  <mat-icon>credit_card</mat-icon>
                  <span>{{permiso.placaTemporal}}</span>
                </div>
                <mat-chip [class]="obtenerEstadoInfo(permiso.estado).class">
                  <mat-icon>{{obtenerEstadoInfo(permiso.estado).icon}}</mat-icon>
                  {{obtenerEstadoInfo(permiso.estado).text}}
                </mat-chip>
              </div>

              <!-- Tipo de vehículo -->
              <div class="permiso-tipo-vehiculo">
                <mat-icon>{{obtenerIconoTipoVehiculo(permiso.tipoVehiculoPermitido)}}</mat-icon>
                <span>{{obtenerTextoTipoVehiculo(permiso.tipoVehiculoPermitido)}}</span>
              </div>

              <!-- Información del permiso -->
              <div class="permiso-body">
                <div class="info-row">
                  <div class="info-label">
                    <mat-icon>help_outline</mat-icon>
                    Motivo:
                  </div>
                  <div class="info-value">{{permiso.motivo}}</div>
                </div>

                <!-- Mostrar info solo si está aprobado -->
                <ng-container *ngIf="estaAprobadoOActivo(permiso.estado)">
                  <div class="info-row">
                    <div class="info-label">
                      <mat-icon>event</mat-icon>
                      Vigencia:
                    </div>
                    <div class="info-value">
                      {{formatearFechaParaMostrar(permiso.fechaInicio)}} - {{formatearFechaParaMostrar(permiso.fechaFin)}}
                    </div>
                  </div>

                  <div class="info-row" *ngIf="permiso.estado === 'ACTIVO' && calcularDiasRestantes(permiso.fechaFin) !== null">
                    <div class="info-label">
                      <mat-icon>timer</mat-icon>
                      Días restantes:
                    </div>
                    <div class="info-value dias-restantes">
                      {{calcularDiasRestantes(permiso.fechaFin)}} días
                    </div>
                  </div>

                  <div class="info-row">
                    <div class="info-label">
                      <mat-icon>pin</mat-icon>
                      Usos:
                    </div>
                    <div class="info-value">
                      {{permiso.usosRealizados}} / {{permiso.usosMaximos || 'Ilimitado'}}
                    </div>
                  </div>

                  <!-- Barra de progreso de usos -->
                  <div class="usos-progress" *ngIf="permiso.usosMaximos">
                    <div class="progress-bar-container">
                      <div class="progress-bar" 
                           [style.width.%]="calcularPorcentajeUsos(permiso.usosRealizados, permiso.usosMaximos)"
                           [style.background-color]="obtenerColorBarraUsos(calcularPorcentajeUsos(permiso.usosRealizados, permiso.usosMaximos))">
                      </div>
                    </div>
                    <span class="progress-label">{{calcularPorcentajeUsos(permiso.usosRealizados, permiso.usosMaximos) | number:'1.0-0'}}% utilizado</span>
                  </div>

                  <div class="info-row" *ngIf="permiso.sucursalesDisponiblesPermiso.length > 0">
                    <div class="info-label">
                      <mat-icon>location_on</mat-icon>
                      Sucursales:
                    </div>
                    <div class="info-value">
                      {{permiso.sucursalesDisponiblesPermiso.length}} disponibles
                    </div>
                  </div>
                </ng-container>

                <!-- Mostrar mensaje si está pendiente -->
                <div class="permiso-pendiente-mensaje" *ngIf="permiso.estado === 'PENDIENTE'">
                  <mat-icon>info</mat-icon>
                  <p>Su solicitud está siendo revisada. Los detalles se mostrarán una vez haya sido procesada su solicitud.</p>
                </div>

                <!-- Mostrar observaciones si está rechazado -->
                <div class="permiso-rechazado-mensaje" *ngIf="permiso.estado === 'RECHAZADO' && permiso.observaciones">
                  <mat-icon>error_outline</mat-icon>
                  <p><strong>Motivo del rechazo:</strong> {{permiso.observaciones}}</p>
                </div>
              </div>

              <!-- Footer de la tarjeta -->
              <div class="permiso-footer">
                <button mat-raised-button 
                        (click)="verDetalles(permiso)"
                        class="btn-ver-detalles-card">
                  <mat-icon>visibility</mat-icon>
                  Ver Detalles Completos
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- Loading -->
        <div class="loading-container" *ngIf="isLoadingPermisos">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando permisos temporales...</p>
        </div>

        <!-- Sin resultados -->
        <div class="no-results" *ngIf="permisos.length === 0 && !isLoadingPermisos">
          <mat-icon>inbox</mat-icon>
          <p>No tiene permisos temporales registrados</p>
          <p class="hint">Los permisos temporales que solicite aparecerán aquí</p>
        </div>

      </div>
    </mat-card-content>
  </mat-card>

  <!-- Modal de Detalles Completos -->
  <div class="modal-overlay" *ngIf="mostrarModalDetalles" (click)="cerrarModalDetalles($event)">
    <div class="encargado-modal modal-detalles-grande" (click)="$event.stopPropagation()">
      
      <div class="modal-header">
        <div class="modal-icon">
          <mat-icon>car_rental</mat-icon>
        </div>
        <h2>Detalles del Permiso Temporal</h2>
      </div>

      <div class="modal-content" *ngIf="permisoSeleccionado">
        
        <!-- Estado del Permiso -->
        <div class="estado-banner" [class]="obtenerClaseEstadoBanner(permisoSeleccionado.estado)">
          <mat-icon>{{obtenerEstadoInfo(permisoSeleccionado.estado).icon}}</mat-icon>
          <div class="estado-info">
            <span class="estado-titulo">Estado Actual:</span>
            <span class="estado-valor">{{obtenerEstadoInfo(permisoSeleccionado.estado).text}}</span>
          </div>
        </div>

        <!-- Grid de 2 Columnas -->
        <div class="modal-grid-container">
          
          <!-- Columna Izquierda -->
          <div class="modal-column">

            <!-- Información del Permiso -->
            <div class="info-section-compact">
              <h3 class="info-section-title-compact">
                <mat-icon>badge</mat-icon>
                Información del Permiso
              </h3>
              
              <div class="info-list">
                <div class="info-item-compact">
                  <label>ID Permiso:</label>
                  <span>#{{permisoSeleccionado.idPermisoTemporal}}</span>
                </div>
                <div class="info-item-compact">
                  <label>Placa Temporal:</label>
                  <span class="placa-destacada">{{permisoSeleccionado.placaTemporal}}</span>
                </div>
                <div class="info-item-compact">
                  <label>Tipo de Vehículo:</label>
                  <span>
                    <mat-icon class="inline-icon">{{obtenerIconoTipoVehiculo(permisoSeleccionado.tipoVehiculoPermitido)}}</mat-icon>
                    {{obtenerTextoTipoVehiculo(permisoSeleccionado.tipoVehiculoPermitido)}}
                  </span>
                </div>
                <div class="info-item-compact full-width-compact">
                  <label>Motivo de la Solicitud:</label>
                  <span class="text-wrap">{{permisoSeleccionado.motivo}}</span>
                </div>
              </div>
            </div>

            <!-- Información de Vigencia (solo si está aprobado) -->
            <div class="info-section-compact" *ngIf="estaAprobadoOActivo(permisoSeleccionado.estado)">
              <h3 class="info-section-title-compact">
                <mat-icon>event</mat-icon>
                Vigencia del Permiso
              </h3>
              
              <div class="info-list">
                <div class="info-item-compact">
                  <label>Fecha de Inicio:</label>
                  <span>{{formatearFechaLegible(permisoSeleccionado.fechaInicio)}}</span>
                </div>
                <div class="info-item-compact">
                  <label>Fecha de Fin:</label>
                  <span>{{formatearFechaLegible(permisoSeleccionado.fechaFin)}}</span>
                </div>
                <div class="info-item-compact" *ngIf="permisoSeleccionado.estado === 'ACTIVO'">
                  <label>Días Restantes:</label>
                  <span class="dias-restantes-destacado">
                    <mat-icon class="inline-icon">timer</mat-icon>
                    {{calcularDiasRestantes(permisoSeleccionado.fechaFin) || 0}} días
                  </span>
                </div>
              </div>
            </div>

            <!-- Información de Usos (solo si está aprobado) -->
            <div class="info-section-compact" *ngIf="estaAprobadoOActivo(permisoSeleccionado.estado)">
              <h3 class="info-section-title-compact">
                <mat-icon>pin</mat-icon>
                Usos del Permiso
              </h3>
              
              <div class="usos-detalle-card">
                <div class="usos-numeros">
                  <div class="uso-item">
                    <span class="uso-label">Realizados</span>
                    <span class="uso-valor realizados">{{permisoSeleccionado.usosRealizados}}</span>
                  </div>
                  <mat-icon class="divider-icon">trending_flat</mat-icon>
                  <div class="uso-item">
                    <span class="uso-label">Máximos</span>
                    <span class="uso-valor maximos">{{permisoSeleccionado.usosMaximos || '∞'}}</span>
                  </div>
                </div>

                <div class="usos-progress-modal" *ngIf="permisoSeleccionado.usosMaximos">
                  <div class="progress-bar-container-modal">
                    <div class="progress-bar-modal" 
                         [style.width.%]="calcularPorcentajeUsos(permisoSeleccionado.usosRealizados, permisoSeleccionado.usosMaximos)"
                         [style.background-color]="obtenerColorBarraUsos(calcularPorcentajeUsos(permisoSeleccionado.usosRealizados, permisoSeleccionado.usosMaximos))">
                    </div>
                  </div>
                  <div class="progress-info">
                    <span class="progress-percentage">{{calcularPorcentajeUsos(permisoSeleccionado.usosRealizados, permisoSeleccionado.usosMaximos) | number:'1.0-0'}}%</span>
                    <span class="progress-text">utilizado</span>
                  </div>
                </div>

                <div class="usos-restantes" *ngIf="permisoSeleccionado.usosMaximos">
                  <mat-icon>info</mat-icon>
                  <span>Usos restantes: <strong>{{(permisoSeleccionado.usosMaximos || 0) - permisoSeleccionado.usosRealizados}}</strong></span>
                </div>
              </div>
            </div>

            <!-- Información de Aprobación (solo si está aprobado) -->
            <div class="info-section-compact" *ngIf="estaAprobadoOActivo(permisoSeleccionado.estado) && permisoSeleccionado.fechaAprobacion">
              <h3 class="info-section-title-compact">
                <mat-icon>verified</mat-icon>
                Información de Aprobación
              </h3>
              
              <div class="info-list">
                <div class="info-item-compact">
                  <label>Fecha de Aprobación:</label>
                  <span>{{formatearFechaLegible(permisoSeleccionado.fechaAprobacion)}}</span>
                </div>
                <div class="info-item-compact full-width-compact" *ngIf="permisoSeleccionado.observaciones">
                  <label>Observaciones:</label>
                  <span class="text-wrap observaciones-text">{{permisoSeleccionado.observaciones}}</span>
                </div>
              </div>
            </div>

            <!-- Información de Rechazo (solo si está rechazado) -->
            <div class="info-section-compact" *ngIf="permisoSeleccionado.estado === 'RECHAZADO'">
              <h3 class="info-section-title-compact">
                <mat-icon>cancel</mat-icon>
                Información del Rechazo
              </h3>
              
              <div class="rechazo-card">
                <mat-icon>error_outline</mat-icon>
                <div class="rechazo-content">
                  <p class="rechazo-titulo">Solicitud Rechazada</p>
                  <p class="rechazo-observaciones">{{permisoSeleccionado.observaciones || 'No se proporcionaron observaciones'}}</p>
                </div>
              </div>
            </div>

            <!-- Sucursales Autorizadas (solo si está aprobado) -->
            <div class="info-section-compact" *ngIf="estaAprobadoOActivo(permisoSeleccionado.estado) && permisoSeleccionado.sucursalesDisponiblesPermiso.length > 0">
              <h3 class="info-section-title-compact">
                <mat-icon>location_on</mat-icon>
                Sucursales Autorizadas ({{permisoSeleccionado.sucursalesDisponiblesPermiso.length}})
              </h3>
              
              <div class="sucursales-autorizadas-list">
                <div class="sucursal-autorizada-card" *ngFor="let sucursal of permisoSeleccionado.sucursalesDisponiblesPermiso">
                  <mat-icon>place</mat-icon>
                  <div class="sucursal-info">
                    <span class="sucursal-nombre">{{sucursal.nombre}}</span>
                    <span class="sucursal-direccion" *ngIf="sucursal.direccionCompleta">{{sucursal.direccionCompleta}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mensaje de Pendiente -->
            <div class="info-section-compact" *ngIf="permisoSeleccionado.estado === 'PENDIENTE'">
              <h3 class="info-section-title-compact">
                <mat-icon>schedule</mat-icon>
                Estado de la Solicitud
              </h3>
              
              <div class="pendiente-card">
                <mat-icon>hourglass_empty</mat-icon>
                <div class="pendiente-content">
                  <p class="pendiente-titulo">Solicitud en Revisión</p>
                  <p class="pendiente-texto">Su solicitud de permiso temporal está siendo revisada por el equipo de administración. Una vez procesada, recibirá una notificación y podrá ver aquí todos los detalles de vigencia, usos permitidos y sucursales autorizadas.</p>
                </div>
              </div>
            </div>

          </div>

          <!-- Columna Derecha -->
          <div class="modal-column">

            <!-- Información de la Suscripción -->
            <div class="info-section-compact">
              <h3 class="info-section-title-compact">
                <mat-icon>card_membership</mat-icon>
                Suscripción Asociada
              </h3>
              
              <div class="suscripcion-card">
                <div class="suscripcion-header">
                  <mat-icon>stars</mat-icon>
                  <span class="plan-nombre">{{permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.nombrePlan}}</span>
                  <mat-chip [class]="'chip-' + permisoSeleccionado.suscripcionCliente.estadoSuscripcion.toLowerCase()">
                    {{permisoSeleccionado.suscripcionCliente.estadoSuscripcion}}
                  </mat-chip>
                </div>

                <div class="info-list">
                  <div class="info-item-compact">
                    <label>ID Suscripción:</label>
                    <span>#{{permisoSeleccionado.suscripcionCliente.idSuscripcion}}</span>
                  </div>
                  <div class="info-item-compact">
                    <label>Código del Plan:</label>
                    <span>{{permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.codigoPlan}}</span>
                  </div>
                  <div class="info-item-compact">
                    <label>Período Contratado:</label>
                    <span>{{permisoSeleccionado.suscripcionCliente.periodoContratado}}</span>
                  </div>
                  <div class="info-item-compact full-width-compact">
                    <label>Descripción:</label>
                    <span class="text-wrap">{{permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.descripcion}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detalles del Plan -->
            <div class="info-section-compact">
              <h3 class="info-section-title-compact">
                <mat-icon>schedule</mat-icon>
                Detalles del Plan
              </h3>
              
              <div class="info-list">
                <div class="info-item-compact">
                  <label>Horas por Día:</label>
                  <span>{{permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.horasDia}} horas</span>
                </div>
                <div class="info-item-compact">
                  <label>Horas Mensuales:</label>
                  <span>{{permisoSeleccionado.suscripcionCliente.horasMensualesIncluidas}} horas</span>
                </div>
                <div class="info-item-compact">
                  <label>Horas Consumidas:</label>
                  <span class="consumo-horas">{{permisoSeleccionado.suscripcionCliente.horasConsumidas}} / {{permisoSeleccionado.suscripcionCliente.horasMensualesIncluidas}}</span>
                </div>
                <div class="info-item-compact">
                  <label>Días Aplicables:</label>
                  <span>{{permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.diasAplicables}}</span>
                </div>
                <div class="info-item-compact full-width-compact">
                  <label>Cobertura Horaria:</label>
                  <span>{{permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.coberturaHoraria}}</span>
                </div>
              </div>
            </div>

            <!-- Información Financiera -->
            <div class="info-section-compact">
              <h3 class="info-section-title-compact">
                <mat-icon>payments</mat-icon>
                Información Financiera
              </h3>
              
              <div class="pricing-card">
                <div class="info-list">
                  <div class="info-item-compact">
                    <label>Precio Base:</label>
                    <span>{{formatearMoneda(permisoSeleccionado.suscripcionCliente.tipoPlanSuscripcionDTO.precioPlan)}}</span>
                  </div>
                  <div class="info-item-compact">
                    <label>Tarifa Base Ref.:</label>
                    <span>{{formatearMoneda(permisoSeleccionado.suscripcionCliente.tarifaBaseReferencia)}}</span>
                  </div>
                  <div class="info-item-compact">
                    <label>Descuento:</label>
                    <span class="descuento-text">{{permisoSeleccionado.suscripcionCliente.descuentoAplicado}}%</span>
                  </div>
                  <div class="info-item-compact precio-final-item">
                    <label>Precio Final:</label>
                    <span class="precio-final-valor">{{formatearMoneda(calcularPrecioFinal(permisoSeleccionado.suscripcionCliente))}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fechas de la Suscripción -->
            <div class="info-section-compact">
              <h3 class="info-section-title-compact">
                <mat-icon>event</mat-icon>
                Fechas de la Suscripción
              </h3>
              
              <div class="info-list">
                <div class="info-item-compact">
                  <label>Fecha de Compra:</label>
                  <span>{{formatearFechaParaMostrar(permisoSeleccionado.suscripcionCliente.fechaCompra)}}</span>
                </div>
                <div class="info-item-compact">
                  <label>Fecha de Inicio:</label>
                  <span>{{formatearFechaParaMostrar(permisoSeleccionado.suscripcionCliente.fechaInicio)}}</span>
                </div>
                <div class="info-item-compact">
                  <label>Fecha de Fin:</label>
                  <span>{{formatearFechaParaMostrar(permisoSeleccionado.suscripcionCliente.fechaFin)}}</span>
                </div>
              </div>
            </div>

            <!-- Sucursales de la Suscripción -->
            <div class="info-section-compact" *ngIf="permisoSeleccionado.suscripcionCliente.sucursalesDisponibles.length > 0">
              <h3 class="info-section-title-compact">
                <mat-icon>location_city</mat-icon>
                Sucursales de la Suscripción ({{permisoSeleccionado.suscripcionCliente.sucursalesDisponibles.length}})
              </h3>
              
              <div class="sucursales-list">
                <div class="sucursal-compact-card" *ngFor="let sucursal of permisoSeleccionado.suscripcionCliente.sucursalesDisponibles">
                  <div class="sucursal-compact-header">
                    <mat-icon>place</mat-icon>
                    <span class="sucursal-nombre">{{sucursal.nombre}}</span>
                    <mat-chip [class]="'chip-' + sucursal.estado.toLowerCase()">{{sucursal.estado}}</mat-chip>
                  </div>
                  <div class="sucursal-compact-details">
                    <div class="detail-row-compact">
                      <mat-icon>location_on</mat-icon>
                      <span>{{sucursal.direccionCompleta}}, {{sucursal.ciudad}}, {{sucursal.departamento}}</span>
                    </div>
                    <div class="detail-row-compact">
                      <mat-icon>schedule</mat-icon>
                      <span>{{sucursal.horaApertura}} - {{sucursal.horaCierre}}</span>
                    </div>
                    <div class="detail-row-compact">
                      <mat-icon>local_parking</mat-icon>
                      <span>Capacidad: {{sucursal.capacidad2Ruedas}} motos / {{sucursal.capacidad4Ruedas}} autos</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>

      </div>

      <div class="modal-actions">
        <button mat-raised-button 
                color="primary" 
                (click)="cerrarModalDetalles()"
                class="close-button">
          <mat-icon>close</mat-icon>
          Cerrar
        </button>
      </div>
    </div>
  </div>

</div>