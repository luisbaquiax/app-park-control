<div class="control-sucursal-container">
  <div class="floating-icons">
    <div class="icon"><mat-icon>store</mat-icon></div>
    <div class="icon"><mat-icon>business</mat-icon></div>
    <div class="icon"><mat-icon>local_parking</mat-icon></div>
    <div class="icon"><mat-icon>location_city</mat-icon></div>
    <div class="icon"><mat-icon>domain</mat-icon></div>
    <div class="icon"><mat-icon>place</mat-icon></div>
    <div class="icon"><mat-icon>apartment</mat-icon></div>
    <div class="icon"><mat-icon>map</mat-icon></div>
  </div>
  <mat-card class="usuario-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="header-icon">store</mat-icon>
        Gestión de Empresas
      </mat-card-title>
      <mat-card-subtitle>Administre las empresas</mat-card-subtitle>
    </mat-card-header>

    <mat-card class="usuario-card">
      <mat-card-content>
        <mat-tab-group #tabGroup animationDuration="300ms" class="sucursales-tabs">
          <!-- TAB 1: create company -->
          <mat-tab label="Nueva Empresa">
            <div class="tab-content">
              <form [formGroup]="companyForm" (ngSubmit)="sendForm()" class="usuario-form">
                <!-- Sección Información de la Empresa -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>store</mat-icon>
                    Información de la Empresa
                  </h3>

                  <!-- Usuario Asignado -->
                  @if (!isEditing) {
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Usuario Asignado</mat-label>
                      <mat-select formControlName="idUsuarioEmpresa">
                        @for (usuario of empresasUsuarios; track $index) {
                        <mat-option [value]="usuario.idUsuario">
                        {{ usuario.nombreUsuario }} | Nombre: {{ usuario.nombre }} {{ usuario.apellido }} | Rol: {{ usuario.nombreRol }}
                        </mat-option>
                        }
                      </mat-select>
                      <mat-icon matPrefix>person</mat-icon>
                      @if (companyForm.get('idUsuarioEmpresa')?.hasError('required')) {
                      <mat-error>Debe seleccionar un usuario</mat-error>
                      }
                    </mat-form-field>
                  </div>
                  }

                  <!-- Nombre Comercial -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Nombre Comercial</mat-label>
                      <input
                        matInput
                        formControlName="nombreComercial"
                        placeholder="Ej: Ingrese el nombre de la empresa"
                      />
                      <mat-icon matPrefix>business</mat-icon>
                      @if (companyForm.get('nombreComercial')?.hasError('required')) {
                      <mat-error> El nombre comercial es requerido </mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <!-- Razón Social -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Razón Social</mat-label>
                      <textarea
                        matInput
                        formControlName="razonSocial"
                        placeholder="Razón social de la empresa"
                        rows="2"
                      ></textarea>
                      <mat-icon matPrefix>gavel</mat-icon>
                      @if (companyForm.get('razonSocial')?.hasError('required')) {
                      <mat-error> La razón social es requerida </mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <!-- Dirección Fiscal -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Dirección Fiscal</mat-label>
                      <textarea
                        matInput
                        formControlName="direccionFiscal"
                        placeholder="Dirección completa de la empresa"
                        rows="2"
                      ></textarea>
                      <mat-icon matPrefix>place</mat-icon>
                    </mat-form-field>
                  </div>

                  <!-- NIT -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>NIT</mat-label>
                      <input
                        matInput
                        type="text"
                        formControlName="nit"
                        placeholder="Ej: 1234567890123"
                        maxlength="13"
                        readonly="{{ isEditing ? true : false }}"
                      />
                      <mat-icon matPrefix>credit_card</mat-icon>
                      @if (companyForm.get('nit')?.hasError('required')) {
                      <mat-error> El NIT es requerido </mat-error>
                      } @if (companyForm.get('nit')?.hasError('minlength') ||
                      companyForm.get('nit')?.hasError('maxlength')) {
                      <mat-error> El NIT debe tener 13 dígitos </mat-error>
                      } @if (companyForm.get('nit')?.hasError('pattern')) {
                      <mat-error> Solo se permiten números </mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <!-- Teléfono y Correo -->
                  <div class="form-row">
                    <!-- Teléfono -->
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Teléfono Principal</mat-label>
                      <input
                        matInput
                        type="tel"
                        formControlName="telefonoPrincipal"
                        placeholder="12345678"
                        maxlength="8"
                      />
                      <mat-icon matPrefix>phone</mat-icon>
                      <mat-hint align="end">
                        {{ companyForm.get('telefonoPrincipal')?.value?.length || 0 }}/8
                      </mat-hint>
                      @if (companyForm.get('telefonoPrincipal')?.hasError('required')) {
                      <mat-error> El teléfono es requerido </mat-error>
                      } @if (companyForm.get('telefonoPrincipal')?.hasError('pattern')) {
                      <mat-error> Solo se permiten números </mat-error>
                      }
                    </mat-form-field>

                    <!-- Correo -->
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Correo Principal</mat-label>
                      <input
                        matInput
                        type="email"
                        formControlName="correoPrincipal"
                        placeholder="nombreEmpresa@ejemplo.com"
                      />
                      <mat-icon matPrefix>email</mat-icon>
                      @if (companyForm.get('correoPrincipal')?.hasError('required')) {
                      <mat-error> El correo es requerido </mat-error>
                      } @if (companyForm.get('correoPrincipal')?.hasError('email')) {
                      <mat-error> Ingrese un correo válido </mat-error>
                      }
                    </mat-form-field>
                  </div>
                </div>

                <!-- Botones de Acción -->
                <div class="form-actions">
                  <button
                    mat-stroked-button
                    type="button"
                    class="cancel-button"
                    (click)="clearForm()"
                  >
                    <mat-icon>cancel</mat-icon>
                    Cancelar
                  </button>

                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="!companyForm.valid || isLoading"
                    class="submit-button"
                  >
                    <mat-spinner
                      *ngIf="isLoading"
                      diameter="20"
                      class="button-spinner"
                    ></mat-spinner>

                    <ng-container *ngIf="!isLoading; else loading">
                      <mat-icon>add_business</mat-icon>
                      <span>Crear Empresa</span>
                    </ng-container>

                    <ng-template #loading>
                      <span>Creando...</span>
                    </ng-template>
                  </button>


                </div>
              </form>
            </div>
          </mat-tab>

          <!-- TAB 2: view companies -->
          <mat-tab label="Empresas registradas">
            <div class="tab-content">
              <!-- Resultados -->
              @if (empresas.length > 0) {
              <div class="results-section">
                <h3 class="section-title">
                  <mat-icon>domain</mat-icon>
                  Empresas disponibles ({{ empresas.length }})
                </h3>

                <div class="table-container">
                  <table mat-table [dataSource]="empresas" class="sucursales-table">
                    <!-- Nombre Comercial -->
                    <ng-container matColumnDef="nombreComercial">
                      <th mat-header-cell *matHeaderCellDef>Nombre comercial</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">store</mat-icon>
                          <span class="cell-text">{{ element.nombreComercial }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- NIT -->
                    <ng-container matColumnDef="nit">
                      <th mat-header-cell *matHeaderCellDef>NIT</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">credit_card</mat-icon>
                          <span class="cell-text">{{ element.nit }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Razón Social -->
                    <ng-container matColumnDef="razonSocial">
                      <th mat-header-cell *matHeaderCellDef>Razón social</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">person</mat-icon>
                          <span class="cell-text">{{ element.razonSocial }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Dirección Fiscal -->
                    <ng-container matColumnDef="direccionFiscal">
                      <th mat-header-cell *matHeaderCellDef>Dirección</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">place</mat-icon>
                          <span class="cell-text">{{ element.direccionFiscal }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Teléfono Principal -->
                    <ng-container matColumnDef="telefonoPrincipal">
                      <th mat-header-cell *matHeaderCellDef>Teléfono</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">phone</mat-icon>
                          <span class="cell-text">{{ element.telefonoPrincipal }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Correo Principal -->
                    <ng-container matColumnDef="correoPrincipal">
                      <th mat-header-cell *matHeaderCellDef>Correo</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">email</mat-icon>
                          <span class="cell-text">{{ element.correoPrincipal }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Estado -->
                    <ng-container matColumnDef="estado">
                      <th mat-header-cell *matHeaderCellDef>Estado</th>
                      <td mat-cell *matCellDef="let element">
                        <div class="cell-content">
                          <mat-icon class="cell-icon">info</mat-icon>
                          <span class="cell-text">{{ element.estado }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Acciones -->
                    <ng-container matColumnDef="acciones">
                      <th mat-header-cell *matHeaderCellDef>Acciones</th>
                      <td mat-cell *matCellDef="let element">
                        <button mat-raised-button color="primary" class="details-button">
                          <mat-icon>person</mat-icon>
                          Ver Encargado
                        </button>
                        <button
                          mat-raised-button
                          color="secondary"
                          class="details-button"
                          (click)="editCompany(element)"
                        >
                          <mat-icon>edit</mat-icon>
                          Editar
                        </button>
                      </td>
                    </ng-container>

                    <!-- Filas -->
                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                  </table>
                </div>
              </div>
              }
              <!-- Mensaje cuando no hay resultados -->
              <div
                class="no-results"
                *ngIf="empresas.length === 0 && idUsuario && !isLoadingEmpresas"
              >
                <mat-icon>inbox</mat-icon>
                <p>No se encontraron sucursales para esta empresa</p>
              </div>
            </div>
          </mat-tab>

          <!-- TAB 3: create user for company -->
          <mat-tab label="Registrar administrador de empresa">
            <div class="tab-content">
              <form [formGroup]="userForm" (ngSubmit)="sendFormUser()" class="usuario-form">
                <!-- Sección de Información Personal -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>person</mat-icon>
                    Información Personal
                  </h3>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Nombre</mat-label>
                      <input matInput formControlName="nombre" placeholder="Ingrese su nombre" />
                      <mat-icon matPrefix>badge</mat-icon>
                      <mat-error *ngIf="userForm.get('nombre')?.hasError('required')">
                        El nombre es requerido
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Apellido</mat-label>
                      <input
                        matInput
                        formControlName="apellido"
                        placeholder="Ingrese su apellido"
                      />
                      <mat-icon matPrefix>badge</mat-icon>
                      <mat-error *ngIf="userForm.get('apellido')?.hasError('required')">
                        El apellido es requerido
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Fecha de Nacimiento</mat-label>
                      <input
                        matInput
                        [matDatepicker]="picker"
                        formControlName="fechaNacimiento"
                      />
                      <mat-icon matPrefix>cake</mat-icon>
                      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                      <mat-datepicker #picker></mat-datepicker>
                      <mat-error *ngIf="userForm.get('fechaNacimiento')?.hasError('required')">
                        La fecha de nacimiento es requerida
                      </mat-error>
                      <mat-error
                        *ngIf="userForm.get('fechaNacimiento')?.hasError('matDatepickerMax')"
                      >
                        Fecha de nacimiento inválida
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>DPI</mat-label>
                      <input
                        matInput
                        formControlName="dpi"
                        placeholder="0000000000000"
                        maxlength="13"
                      />
                      <mat-icon matPrefix>credit_card</mat-icon>
                      <mat-hint align="end"
                        >{{ userForm.get('dpi')?.value?.length || 0 }}/13</mat-hint
                      >
                      <mat-error *ngIf="userForm.get('dpi')?.hasError('required')">
                        El DPI es requerido
                      </mat-error>
                      <mat-error *ngIf="userForm.get('dpi')?.hasError('pattern')">
                        El DPI debe contener solo números
                      </mat-error>
                      <mat-error
                        *ngIf="
                          userForm.get('dpi')?.hasError('minlength') ||
                          userForm.get('dpi')?.hasError('maxlength')
                        "
                      >
                        El DPI debe tener exactamente 13 dígitos
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Correo Electrónico</mat-label>
                      <input
                        matInput
                        type="email"
                        formControlName="correo"
                        placeholder="correo@ejemplo.com"
                      />
                      <mat-icon matPrefix>email</mat-icon>
                      <mat-error *ngIf="userForm.get('correo')?.hasError('required')">
                        El correo es requerido
                      </mat-error>
                      <mat-error *ngIf="userForm.get('correo')?.hasError('email')">
                        Ingrese un correo válido
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Teléfono</mat-label>
                      <input
                        matInput
                        type="tel"
                        formControlName="telefono"
                        placeholder="12345678"
                        maxlength="8"
                      />
                      <mat-icon matPrefix>phone</mat-icon>
                      <mat-hint align="end"
                        >{{ userForm.get('telefono')?.value?.length || 0 }}/8</mat-hint
                      >
                      <mat-error *ngIf="userForm.get('telefono')?.hasError('required')">
                        El teléfono es requerido
                      </mat-error>
                      <mat-error *ngIf="userForm.get('telefono')?.hasError('pattern')">
                        El teléfono debe contener 8 dígitos
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Sección de Dirección -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>location_on</mat-icon>
                    Información de Dirección
                  </h3>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>País</mat-label>
                      <mat-select formControlName="pais">
                        <mat-option value="Guatemala">
                          <mat-icon>flag</mat-icon>
                          Guatemala
                        </mat-option>
                      </mat-select>
                      <mat-icon matPrefix>public</mat-icon>
                      <mat-error *ngIf="userForm.get('pais')?.hasError('required')">
                        El país es requerido
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Departamento</mat-label>
                      <mat-select
                        formControlName="departamento"
                        (selectionChange)="onDepartamentoChange()"
                      >
                        <mat-option *ngFor="let depto of departamentos" [value]="depto">
                          {{ depto }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matPrefix>map</mat-icon>
                      <mat-error *ngIf="userForm.get('departamento')?.hasError('required')">
                        El departamento es requerido
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Municipio/Ciudad</mat-label>
                      <mat-select
                        formControlName="ciudad"
                        [disabled]="!userForm.get('departamento')?.value"
                      >
                        <mat-option
                          *ngFor="let municipio of municipiosFiltrados"
                          [value]="municipio"
                        >
                          {{ municipio }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matPrefix>location_city</mat-icon>
                      <mat-error *ngIf="userForm.get('ciudad')?.hasError('required')">
                        El municipio es requerido
                      </mat-error>
                      <mat-hint *ngIf="!userForm.get('ciudad')?.value">
                        Seleccione primero un departamento
                      </mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Código Postal</mat-label>
                      <input
                        matInput
                        formControlName="codigoPostal"
                        placeholder="01001"
                        maxlength="5"
                      />
                      <mat-icon matPrefix>markunread_mailbox</mat-icon>
                      <mat-hint align="end"
                        >{{ userForm.get('codigoPostal')?.value?.length || 0 }}/5</mat-hint
                      >
                      <mat-error *ngIf="userForm.get('codigoPostal')?.hasError('required')">
                        El código postal es requerido
                      </mat-error>
                      <mat-error *ngIf="userForm.get('codigoPostal')?.hasError('pattern')">
                        El código postal debe tener 5 dígitos
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Dirección Completa</mat-label>
                      <textarea
                        matInput
                        formControlName="direccionCompleta"
                        placeholder="Ingrese su dirección completa (calle, avenida, número de casa, zona, colonia, etc.)"
                        rows="3"
                      ></textarea>
                      <mat-icon matPrefix>home</mat-icon>
                      <mat-hint
                        >Incluya calle, avenida, número de casa, zona, colonia y cualquier
                        referencia importante</mat-hint
                      >
                      <mat-error *ngIf="userForm.get('direccionCompleta')?.hasError('required')">
                        La dirección completa es requerida
                      </mat-error>
                      <mat-error
                        *ngIf="userForm.get('direccionCompleta')?.hasError('minlength')"
                      >
                        La dirección debe tener al menos 10 caracteres
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Sección de Credenciales -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>lock</mat-icon>
                    Credenciales de Acceso
                  </h3>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Nombre de Usuario</mat-label>
                      <input
                        matInput
                        formControlName="nombreUsuario"
                        placeholder="Ingrese su nombre de usuario"
                      />
                      <mat-icon matPrefix>account_circle</mat-icon>
                      <mat-error *ngIf="userForm.get('nombreUsuario')?.hasError('required')">
                        El nombre de usuario es requerido
                      </mat-error>
                      <mat-error *ngIf="userForm.get('nombreUsuario')?.hasError('minlength')">
                        El nombre de usuario debe tener al menos 3 caracteres
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Contraseña Temporal</mat-label>
                      <input
                        matInput
                        [type]="hidePassword ? 'password' : 'text'"
                        formControlName="contraseniaHash"
                        placeholder="Mínimo 4 caracteres"
                      />
                      <mat-icon matPrefix>vpn_key</mat-icon>
                      <button
                        mat-icon-button
                        matIconSuffix
                        (click)="hidePassword = !hidePassword"
                        [attr.aria-label]="'Ocultar contraseña'"
                        [attr.aria-pressed]="hidePassword"
                        type="button"
                      >
                        <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                      </button>
                      <mat-hint
                        >Esta es una contraseña temporal. El usuario deberá cambiarla en su primer
                        inicio</mat-hint
                      >
                      <mat-error *ngIf="userForm.get('contraseniaHash')?.hasError('required')">
                        La contraseña es requerida
                      </mat-error>
                      <mat-error *ngIf="userForm.get('contraseniaHash')?.hasError('minlength')">
                        La contraseña debe tener al menos 4 caracteres
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Botones de Acción -->
                <div class="form-actions">
                  <button
                    mat-stroked-button
                    type="button"
                    class="cancel-button"
                    (click)="clearForm()"
                  >
                    <mat-icon>cancel</mat-icon>
                    Cancelar
                  </button>

                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="!userForm.valid || isLoading"
                    class="submit-button"
                  >
                    <mat-spinner
                      *ngIf="isLoading"
                      diameter="20"
                      class="button-spinner"
                    ></mat-spinner>
                    <mat-icon *ngIf="!isLoading">person_add</mat-icon>
                    <span *ngIf="!isLoading">Crear Usuario</span>
                    <span *ngIf="isLoading">Creando...</span>
                  </button>
                </div>
              </form>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </mat-card>
</div>
